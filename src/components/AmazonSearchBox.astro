---
const {
  title = "Amazon durchsuchen",
  placeholder = "Produkt, Marke, ASIN â€¦",
  position = "right",      // "left" | "right"
  market = "de",           // de, com, co.uk, fr, it, es
  defaultQuery = "",
  tag = import.meta.env.PUBLIC_AMAZON_TAG || "SmartRichter-21",
} = Astro.props;

// Externe PA-API (optional). Wenn leer: kein Fetch, reines Redirect-Formular.
const API_BASE = import.meta.env.PUBLIC_AMAZON_API_BASE || "";

const hosts = {
  de: "https://www.amazon.de/s",
  com: "https://www.amazon.com/s",
  "co.uk": "https://www.amazon.co.uk/s",
  fr: "https://www.amazon.fr/s",
  it: "https://www.amazon.it/s",
  es: "https://www.amazon.es/s",
};
const action = hosts[market] ?? hosts.de;
---

<aside class={`az-sidebar az-${position}`}>
  <div class="az-card">
    <div class="az-title">{title}</div>

    <!-- Standard: echtes GET-Formular zu Amazon; funktioniert immer -->
    <form action={action} method="GET" target="_blank" rel="noopener" class="az-form" id="azForm">
      <input type="hidden" name="tag" value={tag} />
      <input class="az-input" type="search" name="k" placeholder={placeholder} value={defaultQuery} aria-label="Auf Amazon suchen" required />
      <button class="az-btn" type="submit">Suchen</button>
    </form>

    <p class="az-note">Werbelink â€¢ Partnerlink</p>

    <!-- Optionaler Inline-Result-Block (nur wenn API_BASE gesetzt ist) -->
    {API_BASE && (
      <div id="azResults" class="az-results" hidden>
        <div class="az-meta"><span id="azTs"></span></div>
        <ul id="azList"></ul>
      </div>
    )}
    {API_BASE && (<div id="azEmpty" class="az-empty" hidden>Keine Treffer.</div>)}
    {API_BASE && (<div id="azErr" class="az-err" hidden>Fehler bei der Suche â€“ Ã¶ffne Amazon-Sucheâ€¦</div>)}
  </div>
</aside>

<style>
  .az-sidebar { position: sticky; top: 24px; align-self: start; }
  .az-card { background: var(--panel,#111318); border:1px solid var(--border,rgba(255,255,255,.12)); border-radius:12px; padding:14px; }
  .az-title { font-weight:700; margin-bottom:8px; }
  .az-form { display:grid; gap:8px; margin-bottom:8px; }
  .az-input { padding:10px 12px; border-radius:10px; border:1px solid var(--border,rgba(255,255,255,.12)); background:rgba(255,255,255,.04); color:var(--text,#e8eaf1); }
  .az-btn { padding:10px 12px; border-radius:10px; border:1px solid var(--border,rgba(255,255,255,.12)); background:var(--primary,#7c9cff); color:#0b0c0f; font-weight:700; cursor:pointer; }
  .az-note { opacity:.7; font-size:.85rem; margin-top:6px; }
  .az-results ul { list-style:none; padding:0; margin:0; display:grid; gap:10px; }
  .az-card-item { display:grid; grid-template-columns: 72px 1fr; gap:10px; align-items:center; border:1px solid var(--border,rgba(255,255,255,.12)); border-radius:10px; padding:8px; }
  .az-card-item img { width:72px; height:72px; object-fit:contain; }
  .az-price { font-weight:700; margin-left:6px; }
  .az-err, .az-empty, .az-meta { opacity:.8; font-size:.9rem; }
  @media (max-width: 900px) { .az-sidebar { position: static; margin-top: 16px; } }
</style>

{API_BASE && (
  <script>
    const API = "{API_BASE}/amazon-search";
    const MARKET = "{market}";
    const TAG = "{tag}";
    const ACTION = "{action}";
    const form = document.getElementById('azForm');
    const list = document.getElementById('azList');
    const box = document.getElementById('azResults');
    const tsEl = document.getElementById('azTs');
    const emptyEl = document.getElementById('azEmpty');
    const errEl = document.getElementById('azErr');

    function openAmazon(q){
      const u = new URL(ACTION);
      u.searchParams.set('k', q);
      u.searchParams.set('tag', TAG);
      window.open(u.toString(), '_blank', 'noopener');
    }

    form?.addEventListener('submit', async (e) => {
      // Nur abfangen, wenn wir eine API nutzen wollen
      e.preventDefault();
      const q = new FormData(form).get('k');
      emptyEl.hidden = true; errEl.hidden = true; box.hidden = true;
      if (list) list.innerHTML = '<li>Ladeâ€¦</li>';

      try {
        const url = new URL(API);
        url.searchParams.set('q', q);
        url.searchParams.set('market', MARKET);
        const r = await fetch(url.toString());
        if (!r.ok) throw new Error('bad status '+r.status);
        const data = await r.json();

        if (!data.items || !data.items.length) {
          emptyEl.hidden = false;
          return;
        }
        list.innerHTML = '';
        for (const it of data.items) {
          const li = document.createElement('li');
          li.className = 'az-card-item';
          li.innerHTML = `
            <img loading="lazy" alt="">
            <div>
              <a href="${it.url}" target="_blank" rel="nofollow noopener sponsored">${it.title || 'Produkt'}</a>
              ${it.price ? `<span class="az-price">${it.price}</span>` : ''}
              ${it.isPrime ? `<span title="Prime">ðŸ”¹</span>` : ''}
            </div>`;
          li.querySelector('img').src = it.image || '/images/placeholder.png';
          li.querySelector('img').alt = it.title || 'Produktbild';
          list.appendChild(li);
        }
        tsEl.textContent = `Stand: ${new Date(data.ts || Date.now()).toLocaleString('de-DE')}`;
        box.hidden = false;
      } catch (err) {
        // Fallback: Normale Amazon-Suche im neuen Tab Ã¶ffnen
        errEl.hidden = false;
        openAmazon(q);
      }
    });
  </script>
)}